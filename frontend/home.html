<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LearnPath | Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --main-bg: #101014;
        --card-bg: #1a1b21;
        --navbar-bg: #17171c;
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --surface: #232334;
        --border-color: #29293d;
        --text: #f4f4fa;
        --text-muted: #bbbccd;
        --accent: #00e4c7;
        --resource-badge: #232342;
        --resource-badge-text: #3fd6b6;
      }
      body {
        background: var(--main-bg);
        color: var(--text);
        font-family: "Segoe UI", sans-serif;
        min-height: 100vh;
      }
      .navbar {
        background: var(--navbar-bg) !important;
      }
      .navbar-brand {
        font-weight: bold;
        font-size: 1.3rem;
        color: var(--primary);
      }
      .dashboard-container {
        max-width: 760px;
        margin: auto;
        margin-top: 38px;
      }
      .input-group input {
        border-radius: 0.6rem 0 0 0.6rem;
        font-size: 1.1rem;
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border-color);
      }
      .input-group input::placeholder {
        color: var(--text-muted);
        opacity: 1;
      }
      .input-group button {
        border-radius: 0 0.6rem 0.6rem 0;
        font-size: 1.1rem;
        background: var(--primary);
        color: #fff;
        border: none;
        transition: background 0.2s;
      }
      .input-group button:active,
      .input-group button:focus {
        background: var(--primary-dark);
        color: #fff;
      }
      .card {
        border-radius: 1.1rem;
        border: none;
        box-shadow: 0 4px 18px 0 rgba(99, 102, 241, 0.11);
        margin-bottom: 22px;
        background: var(--card-bg);
        color: var(--text);
        border-left: 4px solid var(--primary);
        transition: box-shadow 0.2s, border-left 0.2s;
      }
      .card:hover {
        box-shadow: 0 8px 32px 0 rgba(99, 102, 241, 0.26);
        border-left: 4px solid var(--accent);
      }
      .card-title {
        font-weight: 600;
        font-size: 1.15rem;
        color: var(--accent);
      }
      .resource-badge {
        font-size: 0.88rem;
        padding: 0.22em 0.6em;
        background-color: var(--resource-badge);
        color: var(--resource-badge-text);
        border-radius: 0.25rem;
        margin-right: 0.4em;
        font-weight: 500;
        display: inline-block;
      }
      .resource-link {
        word-break: break-all;
        color: var(--accent);
      }
      .resource-link:hover {
        text-decoration: underline;
        color: var(--primary);
      }
      .step-number {
        width: 38px;
        height: 38px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: var(--primary);
        color: #fff;
        font-weight: bold;
        margin-right: 15px;
        font-size: 1.1rem;
        border: 2px solid var(--accent);
      }
      .logout-btn {
        border-radius: 0.5rem;
        font-size: 1rem;
        color: var(--accent);
        border: 1px solid var(--accent);
        transition: background 0.2s, color 0.2s;
      }
      .logout-btn:hover,
      .logout-btn:focus {
        background: var(--accent);
        color: var(--main-bg);
        border-color: var(--accent);
      }
      #output {
        min-height: 140px;
      }
      .fade-in {
        animation: fadeIn 0.7s;
      }
      .summary-section {
        background: var(--surface);
        border-left: 6px solid var(--primary);
        padding: 1.3em 1.2em;
        border-radius: 0.95em;
        font-size: 1.09em;
        margin-top: 2em;
        color: var(--text);
        box-shadow: 0 2px 12px 0 rgba(99, 102, 241, 0.1);
      }
      .no-steps {
        color: var(--text-muted);
        background: #18181c;
        border: 1px solid #26263a;
        padding: 1.4em;
        border-radius: 1em;
        text-align: center;
        font-size: 1.08em;
        margin-bottom: 2em;
      }
      .alert {
        background: #231a1c;
        color: #ffb6b6;
        border: 1px solid #572b3f;
      }
      .text-muted,
      .alert-warning {
        color: var(--text-muted) !important;
      }
      @keyframes fadeIn {
        0% {
          opacity: 0;
          transform: translateY(16px);
        }
        100% {
          opacity: 1;
          transform: none;
        }
      }
      @media (max-width: 600px) {
        .dashboard-container {
          margin-top: 15px;
        }
        .card {
          margin-bottom: 13px;
        }
        .input-group input,
        .input-group button {
          font-size: 1rem;
        }
        .navbar-brand {
          font-size: 1rem;
        }
        .summary-section {
          font-size: 1em;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Learning Project</a>
        <!-- <button class="btn logout-btn" onclick="History()">
          <i class="bi bi-box-arrow-right"></i> History
        </button> -->
        <button class="btn logout-btn" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>
    </nav>

    <div class="dashboard-container py-4">
      <h3 class="mb-4 text-center" style="color: var(--primary)">
        What do you want to learn next?
      </h3>
      <div class="input-group mb-4 shadow-sm">
        <input
          type="text"
          id="user-input"
          class="form-control"
          placeholder="e.g. Bash scripting, Git, Networking..."
          autocomplete="off"
          aria-label="Learning Topic"
          onkeyup="if(event.key==='Enter'){submitPrompt();}"
        />
        <button
          class="btn"
          style="background: var(--primary)"
          onclick="submitPrompt()"
          id="generate-btn"
        >
          <i class="bi bi-magic"></i> Generate
        </button>
      </div>

      <div id="output"></div>
    </div>

    <template id="step-card-template">
      <div class="card fade-in">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <div class="step-number"></div>
            <span class="card-title"></span>
          </div>
          <div class="card-text mb-2"></div>
          <div class="mb-1 fw-semibold" style="color: var(--primary)">
            Resources:
          </div>
          <ul class="mb-0 resource-list"></ul>
        </div>
      </div>
    </template>

    <script>
      const apiBase = "http://localhost:3000";

      window.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "auth.html";
        }
      });
      function History() {
        window.location.href = "history.html";
      }
      function logout() {
        localStorage.removeItem("token");
        window.location.href = "auth.html";
      }

      function showLoading() {
        const output = document.getElementById("output");
        output.innerHTML = `
          <div class="d-flex justify-content-center align-items-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-3 text-muted">Generating your learning path...</span>
          </div>
        `;
      }

      function formatResource(resource) {
        if (!resource) {
          return `<li><span class="resource-badge">Other</span> Resource not defined</li>`;
        }
        if (typeof resource === "string" && resource.startsWith("http")) {
          return `<li><span class="resource-badge">Link</span>
            <a class="resource-link" href="${resource}" target="_blank" rel="noopener">${resource}</a>
          </li>`;
        }
        if (typeof resource === "object" && resource.url) {
          const label = resource.type
            ? resource.type.charAt(0).toUpperCase() + resource.type.slice(1)
            : "Resource";
          return `<li>
            <span class="resource-badge">${label}</span>
            <a class="resource-link" href="${resource.url}" target="_blank" rel="noopener">${resource.url}</a>
          </li>`;
        }
        return `<li><span class="resource-badge">Other</span> ${resource}</li>`;
      }

      function getStepTitle(stepObj, idx) {
        return (
          stepObj.title ||
          stepObj.milestone ||
          stepObj.step_title ||
          stepObj.step_name ||
          (typeof stepObj.step === "string" ? stepObj.step : null) ||
          (typeof stepObj.milestone === "string" ? stepObj.milestone : null) ||
          (stepObj.step_number ? `Step ${stepObj.step_number}` : null) ||
          `Step ${idx + 1}`
        );
      }

      function getStepNumber(stepObj, idx) {
        if (
          typeof stepObj.step === "number" ||
          (typeof stepObj.step === "string" && !isNaN(stepObj.step))
        ) {
          return stepObj.step;
        }
        if (typeof stepObj.step_number === "number") {
          return stepObj.step_number;
        }
        return idx + 1;
      }

      function getStepDetails(stepObj) {
        return stepObj.details || stepObj.description || stepObj.info || "";
      }

      async function submitPrompt() {
        const token = localStorage.getItem("token");
        const userInput = document.getElementById("user-input").value.trim();
        const output = document.getElementById("output");
        const btn = document.getElementById("generate-btn");

        if (!token) return logout();
        if (!userInput) {
          output.innerHTML = `<div class="alert alert-warning fade-in">Please enter a topic.</div>`;
          return;
        }

        btn.disabled = true;
        showLoading();

        try {
          const res = await fetch(`${apiBase}/api/learning/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ userInput }),
          });

          const data = await res.json();
          output.innerHTML = "";

          if (
            data.learning_path &&
            Array.isArray(data.learning_path) &&
            data.learning_path.length
          ) {
            let stepsRendered = 0;
            data.learning_path.forEach((step, idx) => {
              const template = document.getElementById("step-card-template");
              const card = template.content.cloneNode(true);

              // Step number
              card.querySelector(".step-number").innerText = getStepNumber(
                step,
                idx
              );

              // Title (robust)
              card.querySelector(".card-title").innerText = getStepTitle(
                step,
                idx
              );

              // Details/description
              const details = getStepDetails(step);
              card.querySelector(".card-text").innerText = details
                ? details
                : "";

              // Resources
              const resourceList = card.querySelector(".resource-list");
              if (
                step.resources &&
                Array.isArray(step.resources) &&
                step.resources.length
              ) {
                resourceList.innerHTML = step.resources
                  .map(formatResource)
                  .join("");
              } else {
                resourceList.innerHTML = `<li class="text-muted">No resources provided.</li>`;
              }

              output.appendChild(card);
              stepsRendered++;
            });

            if (!stepsRendered) {
              output.innerHTML = `<div class="no-steps fade-in">No learning steps found for this topic. Try again!</div>`;
            }

            if (data.user_memory_update) {
              output.innerHTML += `<div class="summary-section fade-in"><b>Your Learning Summary:</b><br/>${data.user_memory_update}</div>`;
            }
          } else {
            output.innerHTML = `
              <div class="alert alert-warning fade-in">
                Unable to parse learning path.<br />
                <pre class="mt-2">${
                  typeof data.raw === "string"
                    ? data.raw
                    : JSON.stringify(data.raw || data, null, 2)
                }</pre>
              </div>`;
          }
        } catch (err) {
          console.error(err);
          output.innerHTML = `<div class="alert alert-danger fade-in">Error fetching learning path. Please try again later.</div>`;
        } finally {
          btn.disabled = false;
        }
      }
    </script>
  </body>
</html>
